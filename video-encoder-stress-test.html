<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">  
  <title>WebCodecs demo: VideoEncoder stress test</title>
</head>

<body>
  <div id="status-in"></div>
  <div id="status-out"></div>

<script>
  const kWidth = 640;
  const kHeight = 480;

  const statusIn = document.getElementById("status-in");
  const statusOut = document.getElementById("status-out");

  function createFrame(r, g, b) {
    const pixelSize = 4;
    const init = {
      timestamp: 0,
      codedWidth: kWidth,
      codedHeight: kHeight,
      format: "RGBA",
    };
    const data = new Uint8Array(init.codedWidth * init.codedHeight * pixelSize);
    for (let x = 0; x < init.codedWidth; x++) {
      for (let y = 0; y < init.codedHeight; y++) {
        const offset = (y * init.codedWidth + x) * pixelSize;
        data[offset] = r;
        data[offset + 1] = g;
        data[offset + 2] = b;
        data[offset + 3] = 0x0ff; // Alpha
      }
    }
    return new VideoFrame(data, init);
  }

  let frameCount = 0;
  function encodeFrame(encoder, frame) {
    statusIn.textContent = "Enqueing frame #" + frameCount +
        ". Encoder queue size: " + encoder.encodeQueueSize;

    const keyFrame = frameCount % 150 == 0;
    encoder.encode(frame, { keyFrame });
    frame.close();
    frameCount++;
  }

  function runEncodeLoop() {
    let frameCountOut = 0;
    const init = {
      output: _ => {
        frameCountOut++;
        statusOut.textContent = "Finished encoding frame #" + frameCountOut;
      },
      error: (e) => {
        console.log(e.message);
      },
    };

    const config = {
      codec: "avc1.42001E",
      width: kWidth,
      height: kHeight,
      bitrate: 2_000_000, // 2 Mbps
    };

    let encoder = new VideoEncoder(init);
    encoder.configure(config);

    let r = 0;
    let g = 100;
    let b = 200;
    for (let i = 0; i < 5000; i++) {
      r = (r + 1) % 255;
      g = (g + 1) % 255;
      b = (b + 1) % 255;
      encodeFrame(encoder, createFrame(r, g, b));
    }

    encoder.flush().then(_ => {
      statusOut.textContent = "Done encoding";
      encoder.close();
    });
  }

  function main() {
    if (!("VideoFrame" in window)) {
      document.body.innerHTML = "<h1>WebCodecs API is not supported.</h1>";
      return;
    }

    runEncodeLoop();
  }

  document.body.onload = main;
</script>
</body>

</html>
